# 2. JavaScript で動的なサイトにしよう

Week1 では、HTML と CSS を使って ToDo アプリの「見た目」を完成させました。しかし、現状ではボタンをクリックしても、タスクを入力しても何も起こりません。
今回、JavaScript を導入し、Todo アプリとして機能するように開発していきます。

**本日のゴール**:

- タスクの追加、完了、削除ができるようになる。
- 入力したタスクがブラウザを閉じても消えないようにする（データ保存）。
- フィルタリング機能や一括削除機能を実装する。

## 2.1. 準備

### 1. todo-app フォルダを VSCode で開く

#### Windows

Windows では WSL 環境に移行してからコマンドを実行する必要があります。  
PowerShell 環境になっている場合は以下のコマンドを実行してください。

```shell
wsl
```

ターミナルの表示が以下のようになっているか確認してください。

```shell
# 間違っている方(PowerShell環境)
PS C:\Users\Windowsのユーザー名>

# 正しい方(WSL環境、一例)
アカウント名@パソコン名:~$
```

WSL 環境になっているのを確認したら、以下を実行してください。

```shell
cd ~/project/todo-app
code .
```

#### Mac

ターミナルで以下を実行してください。

```shell
cd ~/project/todo-app
code .
```

### 2. JavaScript ファイルの作成と読み込みを行う

1. JavaScript ファイルを作成します。VSCode の GUI を使用して作成します。  
   もしくは、以下のコマンドを使用して作成することも可能です。

```shell
touch script.js
```

2. HTML ファイルに JavaScript ファイルを読み込ませます。  
   `index.html`を開き、`</body>`タグの直前に以下の 1 行を追加して保存します。

```html
<script src="script.js"></script> <!-- この行を追加 -->
</body>
```

**ポイント**: CSS は`<head>`タグ内で読み込みましたが、JavaScript は`</body>`の直前で読み込むのが一般的です。これはタグが上から順に解析されていくため、`<head>`タグに書くと`<body>`以降が解析される前に JavaScript の実行が行われてしまうためです。もし、JavaScript の中で HTML 要素の操作を行うプログラムが入っていたら、解析前の HTML 要素を操作することになってしまい、エラーになってしまいます。

### 3. ダミーの ToDo を削除する

Week1 で表示していたダミーの ToDo 削除します。index.html から以下の部分を削除してください。

```html
<div class="todo-item">
  <input type="checkbox" class="todo-checkbox" />
  <span class="todo-text">発表資料作成</span>
  <div class="todo-actions">
    <button class="edit-btn">
      <i class="fas fa-edit"></i>
    </button>
    <button class="delete-btn">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</div>
<div class="todo-item">
  <input type="checkbox" class="todo-checkbox" />
  <span class="todo-text">課題</span>
  <div class="todo-actions">
    <button class="edit-btn">
      <i class="fas fa-edit"></i>
    </button>
    <button class="delete-btn">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</div>
```

また、統計情報も編集します。総タスク数と未完了の数が 2 になっているので、0 にしてください。

```html
<div class="todo-stats">
  <div class="stat-item">
    <span class="stat-label">総タスク数:</span>
    <span class="stat-value" id="totalTasks">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">完了済み:</span>
    <span class="stat-value" id="completedTasks">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">未完了:</span>
    <span class="stat-value" id="activeTasks">0</span>
  </div>
</div>
```

### 3. Git にコミット記録を残します。

```shell
git add .
git commit -m "script.jsを追加"
git push
```

## 2.3 JavaScript の基本と DOM 操作

JavaScript の役割は、「いつ」「何を」「どうする」という命令をブラウザに与えることです。例えば、「追加ボタンが**クリックされたとき**に」「入力欄の文字を」「リストに追加する」といった具合です。

この「何を」にあたる HTML の各要素（ボタン、入力欄など）を、JavaScript では**DOM (Document Object Model)** という仕組みを通じて操作します。

まずは、使う変数の宣言と初期化処理部分を作成しましょう。

### 1. `script.js`に以下のコードを記述してください。

```javascript
// 変数宣言&初期化
let todos = []; // タスクを管理する配列
let currentFilter = "all"; // 現在のフィルター状態

// HTML要素
let todoInput, addBtn, todoList, filterBtns, clearCompletedBtn, clearAllBtn;
let totalTasksEl, completedTasksEl, activeTasksEl;

// HTMLの解析が終了したときに実行される処理
document.addEventListener("DOMContentLoaded", () => {
  // HTML要素を取得して、変数に保存する
  todoInput = document.getElementById("todoInput");
  addBtn = document.getElementById("addBtn");
  todoList = document.getElementById("todoList");
  filterBtns = document.querySelectorAll(".filter-btn");
  clearCompletedBtn = document.getElementById("clearCompleted");
  clearAllBtn = document.getElementById("clearAll");
  totalTasksEl = document.getElementById("totalTasks");
  completedTasksEl = document.getElementById("completedTasks");
  activeTasksEl = document.getElementById("activeTasks");
});
```

**ポイント**: `document.getElementById("todoInput")`: `id="todoInput"`を持つ HTML 要素を取得するための命令です。

### 2. Git にコミット記録を残します。

```shell
git add .
git commit -m "グローバル変数の初期化処理を追加"
git push
```

## 2.4 タスクを追加する機能の実装

ユーザーが入力したタスクを画面に表示する機能を実装します。

### 1. ファイルの末尾に以下を追記してください

```javascript
// タスク追加
function addTodo() {
  const text = todoInput.value.trim(); // 入力されたテキストを取得し、前後の空白を削除
  if (!text) return; // テキストが空なら何もしない

  // 新しいタスクのデータを作成
  const todo = {
    id: Date.now(), // ユニークなIDとして現在時刻のタイムスタンプを使用
    text: text,
    completed: false, // 最初は未完了
  };

  todos.push(todo); // 配列にタスクを追加
  renderTodos(); // タスクを再描画
  todoInput.value = ""; // 入力欄を空にする
}

// タスク完了切替
function renderTodos() {
  // 実際のタスクを描画する処理（後で詳しく実装）
  todoList.innerHTML = todos
    .map(
      (todo) => `
        <div class="todo-item">
            <span class="todo-text">${todo.text}</span>
        </div>
    `
    )
    .join("");
}
```

**ポイント**

- `todos.push()`: `todos` という配列に新しい `todo` オブジェクトを追加しています。
- `renderTodos()`: `todos` 配列の中身をもとに、HTML を動的に生成して画面に表示する重要なメソッドです。

### 2. 「HTML の解析が終了したときに実行される処理」の末尾( `activeTasksEl = document.getElementById("activeTasks");`の下)に以下を追記してください

```javascript
// 各イベントのリスナーを設定
addBtn.addEventListener("click", addTodo); // 「+」ボタンがクリックされたらaddTodoメソッドを呼び出す
todoInput.addEventListener("keypress", (e) => {
  console.log(e);
  if (e.key === "Enter") addTodo();
});
```

**ポイント**: `addEventListener`: `click` や `keypress` といったイベント（ユーザーの操作）を監視し、指定された処理を実行します。

### 3. Git にコミット記録を残します。

```shell
git add .
git commit -m "タスク追加機能を追加"
git push
```

これで、入力欄にテキストを入れて「+」ボタンか Enter キーを押すと、タスクがリストに追加されるようになりました！

## 2.5 データの永続化 (Local Storage)

現状では、ブラウザをリロードすると追加したタスクがすべて消えてしまいます。これを防ぐために、ブラウザの localStorage という機能を使ってデータを保存しましょう。

### 1. ファイルの末尾に以下を追加します

```javascript
// LocalStorageへの保存
function saveTodos() {
  localStorage.setItem("todos", JSON.stringify(todos)); // todos配列をJSON形式の文字列に変換してlocalStorageに保存
}

// LocalStorageからの読み込み
function loadTodos() {
  const todos = localStorage.getItem("todos"); // localStorageからデータを読み込む
  return todos ? JSON.parse(todos) : []; // JSONオブジェクトに変換して返す
}
```

### 2. 「HTML の解析が終了したときに実行される処理」の末尾(`todoInput.addEventListener(...);`の下)に以下を追記してください

```javascript
// localStorageからタスクデータを読み込んで描画
todos = loadTodos();
renderTodos();
```

### 3. addTodo 関数を以下のように編集してください

```js
// タスク追加
function addTodo() {
  // ... (前半は同じ)
  todos.push(todo); // 配列にタスクを追加
  saveTodos(); // タスク追加後にデータを保存 ← 追加
  renderTodos(); // タスクを再描画
  todoInput.value = ""; // 入力欄を空にする
}
```

### 4. Git にコミット記録を残します。

```shell
git add .
git commit -m "タスクデータを永続化"
git push
```

これで、タスクを追加した後にリロードしてもデータが消えなくなりました。

## 2.6 タスクの完了と削除

タスクを完了状態にしたり、リストから削除したりする機能を実装します。

### 1. 以下をファイルの末尾に追記します

```javascript
// タスク完了切替
function toggleTodo(id) {
  const todo = todos.find((t) => t.id === id); // IDでタスクを検索
  if (todo) {
    todo.completed = !todo.completed; // completedプロパティを反転させる
    saveTodos();
    renderTodos();
  }
}

// タスク削除
function deleteTodo(id) {
  // 確認ダイアログを表示
  if (confirm("このタスクを削除しますか？")) {
    todos = todos.filter((t) => t.id !== id); // IDが一致しないタスクだけを残す
    saveTodos();
    renderTodos();
  }
}
```

**ポイント**: `confirm()`は、ユーザーに「OK」「キャンセル」を求めるダイアログを表示し、OK が押されたら `true` を返します。

### 2. `renderTodos`を以下に置き換えて、チェックボックスや削除ボタン、編集機能などを正しく表示・機能するようにします。

```javascript
function renderTodos() {
  todoList.innerHTML = todos
    .map(
      (todo) => `
        <div class="todo-item ${
          todo.completed ? "completed" : ""
        }" data-todo-id="${todo.id}">
            <input type="checkbox"
                   class="todo-checkbox"
                   ${todo.completed ? "checked" : ""}
                   onchange="toggleTodo(${todo.id})">

            <span class="todo-text">${todo.text}</span>

            <div class="todo-actions">
                <button class="delete-btn" onclick="deleteTodo(${todo.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `
    )
    .join("");
}
```

**ポイント**

- `onchange` や `onclick` 属性に直接 JavaScript のコードを記述しています。
- 三項演算子 (`条件 ? A : B`) を使って、`todo.completed` の状態に応じて `completed` クラスや `checked` 属性を付与しています。

### 3. Git にコミット記録を残します。

```shell
git add .
git commit -m "タスクの完了切替と削除機能を追加"
git push
```

## 2.7 統計情報をリアルタイムに更新しよう

タスクを追加したり、完了状態を変更したりした際に、画面下部にある「総タスク数」「完了済み」「未完了」の統計情報もリアルタイムで更新されるようにしましょう。

### 1. 以下をファイルの末尾に追記します

```javascript
// 統計更新
function updateStats() {
  const total = todos.length;
  const completed = todos.filter((t) => t.completed).length;
  const active = total - completed;

  totalTasksEl.textContent = total;
  completedTasksEl.textContent = completed;
  activeTasksEl.textContent = active;
}
```

**ポイント**

- `todos.length`で全タスク数を取得します。
- `.filter(t => t.completed)`で`completed`が`true`のタスクだけを抽出し、その`.length`で完了済みタスク数を数えます。
- `textContent`プロパティを使って、取得した HTML 要素のテキストを計算結果で上書きします。

### 2. `updateStats`を以下の場所でそれぞれ追記してください

「HTML の解析が終了したときに実行される処理」:

```javascript
renderTodos(); // ...ここまで同じ

// 統計情報の更新
updateStats();
```

`addTodo`:

```javascript
// ...
saveTodos(); // タスク追加後にデータを保存
renderTodos(); // タスクを再描画
updateStats(); // 統計情報の更新 ← 追加
todoInput.value = ""; // 入力欄を空にする
```

`toggleTodo`:

```javascript
// ...
saveTodos();
renderTodos();
updateStats(); // 追加
```

`deleteTodo`:

```javascript
// ...
todos = todos.filter((t) => t.id !== id);
saveTodos();
renderTodos();
updateStats(); // 追加
```

### 3. Git にコミット記録を残します。

```shell
git add .
git commit -m "タスクデータを統計情報に反映"
git push
```

## 2.8 入力データを HTML エスケープしよう

### 試してみよう

入力欄に以下をコピーして Enter を押し、 ToDo を作ってみましょう。

```html
<input type="text" />
```

ToDo リストに入力欄が出来てしまいました。これを`innerHTML`と`textContent`を使って直します。

### 1. 以下をファイルの末尾に追記します

```javascript
// HTMLエスケープ
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}
```

`div`要素を作り、`textContent`と`innerHTML`を使って文字列の変換(エスケープ)を行います。これにより、`<`や`>`は`&lt;`や`&gt;`に置き換えられます。
なお、ここで作られた`div`要素はこの関数の実行中にメモリ上にあるのみで、index.html や DOM ツリーには(関連付けを行わない限り)影響がありません。
また、lt は larger than の略、gt は greater than の略です。

### 2. `renderTodos`を編集します

以下の行を

```js
<span class="todo-text">${todo.text}</span>
```

以下に置き換えてください。

```js
<span class="todo-text">${escapeHtml(todo.text)}</span>
```

### 3. Git にコミット記録を残します。

```shell
git add .
git commit -m "入力データのHTMLエスケープを実装"
git push
```

入力した HTML がそのまま表示されているのが分かるはずです。

## 2.9 フィルタリング機能を実装しよう

「すべて」「未完了」「完了済み」ボタンをクリックしたときに、表示されるタスクを切り替える機能を実装します。

### 1. ファイルの末尾に以下を追記してください

```javascript
// フィルタ切替
function setFilter(filter) {
  currentFilter = filter; // 現在のフィルター状態を更新

  // ボタンのアクティブ状態を更新
  filterBtns.forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.filter === filter);
  });

  renderTodos(); // フィルターを適用して再描画
}

// フィルタ適用
function getFilteredTodos() {
  switch (currentFilter) {
    case "active":
      return todos.filter((t) => !t.completed);
    case "completed":
      return todos.filter((t) => t.completed);
    default: // "all" の場合
      return todos;
  }
}
```

**ポイント**

- `currentFilter` に、押されたボタンの種類（`'all'`, `'active'`, `'completed'`）を保存します。
- `classList.toggle("active", 条件)`は、条件が `true` なら `active` クラスを追加し、`false` なら削除するメソッドです。これにより、押されたボタンだけがハイライトされます。

### 2. 「各イベントのリスナーを設定」の下に以下を追記してください

```javascript
filterBtns.forEach((btn) => {
  btn.addEventListener("click", (e) => {
    setFilter(e.target.dataset.filter);
  });
});
```

**ポイント**

- `forEach` を使って、取得した 3 つのボタンそれぞれにイベントを設定します。
- `e.target` はクリックされたボタン要素そのものを指します。
- `dataset.filter` は、HTML の `data-filter="all"`のようなカスタムデータ属性の値を取得する方法です。

### 3. renderTodo を以下に置き換えて、フィルタリング機能に対応させます。

```javascript
function renderTodos() {
  const filteredTodos = getFilteredTodos();

  if (filteredTodos.length === 0) {
    todoList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-clipboard-list" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
        <p style="color: #666; text-align: center;">
          ${
            currentFilter === "all"
              ? "タスクがありません。新しいタスクを追加してください。"
              : currentFilter === "active"
              ? "未完了のタスクがありません。"
              : "完了済みのタスクがありません。"
          }
        </p>
      </div>
    `;
    return;
  }

  todoList.innerHTML = filteredTodos
    .map(
      (todo) => `
        <div class="todo-item ${
          todo.completed ? "completed" : ""
        }" data-todo-id="${todo.id}">
            <input type="checkbox"
                   class="todo-checkbox"
                   ${todo.completed ? "checked" : ""}
                   onchange="toggleTodo(${todo.id})">

            <span class="todo-text">${escapeHtml(todo.text)}</span>

            <div class="todo-actions">
                <button class="delete-btn" onclick="deleteTodo(${todo.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `
    )
    .join("");
}
```

### 4. Git にコミット記録を残します。

```shell
git add .
git commit -m "フィルタリング機能を追加"
git push
```

## 2.10 一括削除機能機能を実装しよう

「完了済みを削除」と「すべて削除」ボタンを機能させます。

### 1. ファイルの末尾に以下を追記してください

```javascript
// 完了済み削除
function clearCompleted() {
  if (confirm("完了済みのタスクをすべて削除しますか？")) {
    todos = todos.filter((t) => !t.completed); // 未完了のタスクだけを残す
    saveTodos();
    renderTodos();
    updateStats();
  }
}

// 全削除
function clearAll() {
  if (confirm("すべてのタスクを削除しますか？この操作は元に戻せません。")) {
    todos = []; // 配列を空にする
    saveTodos();
    renderTodos();
    updateStats();
  }
}
```

**ポイント**

- `clearCompleted` では、`.filter()`を使って未完了のタスク（`!t.completed`）だけを新しい配列として残しています。
- `clearAll` では、`this.todos` に空の配列`[]`を代入することで、すべてのタスクを削除しています。
- どちらの処理の後も、`saveTodos` で `localStorage` を更新し、`renderTodos` と `updateStats` で画面を更新するのを忘れないようにしましょう。

### 2. 「各イベントのリスナーを設定」の下に以下を追記してください

```javascript
clearCompletedBtn.addEventListener("click", clearCompleted);
clearAllBtn.addEventListener("click", clearAll);
```

### 3. Git にコミット記録を残します。

```shell
git add .
git commit -m "一括削除機能機能を追加"
git push
```
